# CITO PROJECT- SYSTEM REQUIREMENTS

- Version: v-d33
- Start date: 20-01-2025

## IDENTIFICAR E EXTRAIR PROCESSOS 

### PIPELINE

1. Obter o HTML da página de resultados da query no site do STF
    - Collection: "case_query" 
    - Campo no documento: "htmlRaw"  
    - Filtrar por documentos com `pipelineStatus = "new"` na collection `case_query`
2. Identificar e xtrair os cards/Processos.
    1.1. Identificar dados de cada processo, e inserir/atualizar o documento na collection `case_data`  

## OBTER HTML DO PROCESSO

### PIPELINE 

1. Solicitar ao usuário o `identity.stfDecisionId` do processo a ser processado.
2. Obter a url da página do processo em `caseContent.caseUrl`.
3. Acessar a url e obter o html completo da página do processo. 
4. Salvar o HTML completo no campo `caseContent.caseHtml` do documento na collection `case_data`.
   - Se o documento não existir, criar um novo documento com o `identity.stfDecisionId` informado, e salvar o HTML completo no campo `caseContent.caseHtml`.
   - Se o documento já existir, atualizar o documento existente com o HTML completo no campo `caseContent.caseHtml`.
5. Atualiza/insere informações de status em `case_data.processing`, `audit` e `status.pipelineStatus`.
   - Quando executado com sucesso `status.pipelineStatus` = `caseScraped`. Quando erro atualizar apenas os campos `processing` e `audit`.
   

   - A conexão com a base de dados MongoDB deve ser realizada utilizando os dados de conexão e autenticação fornecidos no arquivo de configuração 'config/mongo.json'.
   - Ao executar o pipeline, solicitar ao usuário  `identity.stfDecisionId`.
   - A cada etapa de execussão, incluir logs detalhados no console, indicando o progresso e quaisquer erros encontrados.
   - Inclua comentários no código.
---

## SANITIZAR HTML DO PROCESSO

### REQUISITOS GERAIS

   - A conexão com a base de dados MongoDB deve ser realizada utilizando os dados de conexão e autenticação fornecidos no arquivo de configuração 'config/mongo.json'.
   - Ao executar o pipeline, solicitar ao usuário se deseja processar todos os documentos com `status.pipelineStatus` igual a `caseScraped` ou apenas um documento específico, identificado pelo seu `identity.stfDecisionId`.
   - A cada etapa de execussão, incluir logs detalhados no console, indicando o progresso e quaisquer erros encontrados.

### PIPELINE

   1. Obter o HTML completo do processo na collection `case_data`, campo `caseContent.caseHtml`.
   2. Extrair do HTML apenas o conteúdo da div que contém o conteúdo do processo. Para identificar podem ser utilizados os seguintes métodos:
      - Path; //*[@id="mat-tab-content-0-0"]/div/div
      - Full xpath: /html/body/app-root/app-home/main/app-search-detail/div/div/div[1]/mat-tab-group/div/mat-tab-body[1]/div/div
      - Selectior: #mat-tab-content-0-0 > div > div
      - JS Path: document.querySelector("#mat-tab-content-0-0 > div > div")
   3. Gravar o conteúdo extraído no campo `caseContent.caseHtmlClean`.
   4. Atualizar/insere informações de status em `processing`, `audit` e `status.pipelineStatus`.
      - Quando executado com sucesso `status.pipelineStatus` = `caseHtmlCleaned`. Quando erro atualizar apenas os campos `processing` e `audit`.


---

## EXTRAIR SEÇÕES DO PROCESSO (caseHtmlClean)

### REQUISITOS GERAIS

   - A conexão com a base de dados MongoDB deve ser realizada utilizando os dados de conexão e autenticação fornecidos no arquivo de configuração 'config/mongo.json'.
   - Ao executar o pipeline, solicitar ao usuário se deseja processar todos os documentos com `status.pipelineStatus` igual a `caseHtmlCleaned` ou apenas um documento específico, identificado pelo seu `stfDecisionId`.
   - A cada etapa de execussão, incluir logs detalhados no console, indicando o progresso e quaisquer erros encontrados.

### PIPELINE

1. Obter o conteúdo sanitizado na collection `case_data`, campo `caseContent.caseHtmlClean`.
2. Identificar e extrair as seguintes seções do conteúdo sanitizado, utilizando os paths, xpaths ou seletores fornecidos:
   - Header (div com dados de identificação do processo)
   - Publicação
   - Partes
   - Ementa
   - Decisão
   - Indexação
   - Legislação
   - Observação
   - Doutrina
3. Gravar o conteúdo extraído, na collection `case_data`, nos respectivos campos:
   - caseContent.rawHeader
   - caseContent.rawPublication
   - caseContent.rawParties
   - caseContent.rawSummary
   - caseContent.rawDecision
   - caseContent.rawKeywords
   - caseContent.rawLegislation
   - caseContent.rawNotes
   - caseContent.rawDoctrine
4. Atualizar/inserir informações de status em `processing`, `audit` e `status`

#### IDENTIFICADORES DE SEÇÕES

Utilize os seguintes seletores, xpaths e padrões para identificar e extrair as seções do conteúdo do processo:

* Seções do Conteúdo 
**Padrão estrutural**: `div.jud-text > h4 + div`

1. Publicação
- **Seletor**: `.jud-text:has(h4:contains('Publicação'))`
- **XPath**: `//div[contains(@class,'jud-text')][./h4[.='Publicação']]`

2. Partes
- **Seletor**: `.jud-text:has(h4:contains('Partes'))`
- **XPath**: `//div[contains(@class,'jud-text')][./h4[.='Partes']]`

3. Ementa
- **Seletor**: `.jud-text:has(h4:contains('Ementa'))`
- **XPath**: `//div[contains(@class,'jud-text')][./h4[.='Ementa']]`

4. Decisão
- **Seletor**: `.jud-text:has(h4:contains('Decisão'))`
- **XPath**: `//div[contains(@class,'jud-text')][./h4[.='Decisão']]`

5. Indexação
- **Seletor**: `.jud-text:has(h4:contains('Indexação'))`
- **XPath**: `//div[contains(@class,'jud-text')][./h4[.='Indexação']]`

6. Legislação
- **Seletor**: `.jud-text:has(h4:contains('Legislação'))`
- **XPath**: `//div[contains(@class,'jud-text')][./h4[.='Legislação']]`

7. Observação
- **Seletor**: `.jud-text:has(h4:contains('Observação'))`
- **XPath**: `//div[contains(@class,'jud-text')][./h4[.='Observação']]`

8. Doutrina
- **Status**: Não presente
- **Padrão**: `.jud-text:has(h4:contains('Doutrina'))`

9. Headers (identificação principal da decisão)
- **Seletor CSS**: `#mat-tab-content-0-0 > div > div > div:nth-child(1) > div.jud-text`
- **XPath**: `//*[@id="mat-tab-content-0-0"]/div/div/div[1]/div[1]`
- **XPath alternativo**: `//div[@class='jud-text'][.//h4[contains(text(),'ADI')]]`
- **Conteúdo esperado**: Número (ADI 7200), Estado (RR), Tipo (AÇÃO DIRETA), Relator, Julgamento, Publicação, Órgão Julgador

* **Padrão Universal para Extração**
Para qualquer seção `[NOME]`:
- **Título**: `//h4[.='[NOME]']`
- **Conteúdo**: `//h4[.='[NOME]']/following-sibling::div[1]`
- **Seção completa**: `//div[contains(@class,'jud-text')][./h4[.='[NOME]']]`

**Nota técnica**: Usar `normalize-space()` no XPath para robustez contra variações de espaçamento.





---

## EXTRAIR PARTES ENVOLVIDAS E PALAVRAS-CHAVE (INDEXAÇÃO)


### REQUISITOS GERAIS

   - A conexão com a base de dados MongoDB deve ser realizada utilizando os dados de conexão e autenticação fornecidos no arquivo de configuração 'config/mongo.json'.
   - Ao executar o pipeline, solicitar ao usuário o`identity.stfDecisionId` do processo a ser processado.
   - A cada etapa de execussão, incluir logs detalhados no console, indicando o progresso e quaisquer erros encontrados.

###  PARTES ENVOLVIDAS

Processar e extrair as **partes envolvidas** do processo

   1. Obter o conteúdo do cmapo caseContent.md.parties
   2. Exrtrair o tipo da parte envolvida, conteúdo antes do ":".Exemplos: 
      - "REQTE.(S): PROCURADORA-GERAL DA REPÚBLICA" -> "REQTE.(S)"
      - "INTDO.(A/S): GOVERNADOR DO ESTADO DO ESPÍRITO SANTO" -> "INTDO.(A/S)"
   3. Exrtrair o nome da parte envolvida, conteúdo após o ":". Exemplos:
      - "REQTE.(S): PROCURADORA-GERAL DA REPÚBLICA" -> "PROCURADORA-GERAL DA REPÚBLICA"
      - "INTDO.(A/S): GOVERNADOR DO ESTADO DO ESPÍRITO SANTO" -> "GOVERNADOR DO ESTADO DO ESPÍRITO SANTO"
   4. Gravar os dados extraídos no campo `caseData.caseParties`, como um array de objetos com os campos:
      - partieType
      - partieName
   5. Atualizar/inserir informações de status em `processing`, `audit` e `status.pipelineStatus`.

###  PALAVRAS-CHAVE

Processar e extrair as **palavras-chave** do processo

   1. Obter o conteúdo do cmapo caseContent.md.keywords
   2. Exrtrair as palavras-chave, separadas por vírgula.
   3. Gravar os dados extraídos no campo `caseData.caseKeywords`, como um array de strings.
   4. Atualizar/inserir informações de status em `processing`, `audit` e `status.pipelineStatus`.
   - 

## SCHEMA JSON DOCUMENTO COLLECTION `case_data`

{
  "_id": "65f0c9f0e1b2c3d4e5f67890",
  "identity.stfDecisionId": "sjur12345",
  "caseIdentification": {
     "caseTitle": "ADI 7518 / ES - ESPÍRITO SANTO",
     "caseClassDetail": "ADI",
     "caseCode": "7518",
     "judgingBody": "Tribunal Pleno",
     "rapporteur": "Min. Gilmar Mendes",
     "caseUrl": "https://jurisprudencia.stf.jus.br/..."
  },
  "dates": {
     "judgmentDate": "16/09/2024",
     "publicationDate": "02/10/2024"
  },
  "caseContent": {
     "caseHtml": "<html>...</html>",
     "caseHtmlClean": "<div class=\"mat-tab-body-wrapper\">...</div>",
     "caseMarkdown": "#### Publicação\n..."
  },
  "rawData": {
     "rawPublication": "PROCESSO ELETRÔNICO\nDJe-s/n DIVULG 01-10-2024 PUBLIC 02-10-2024",
     "rawParties": "REQTE.(S): PROCURADORA-GERAL DA REPÚBLICA\nINTDO.(A/S): GOVERNADOR DO ESTADO DO ESPÍRITO SANTO",
     "rawSummary": "Ação direta de inconstitucionalidade. 2. Licença-parental...",
     "rawDecision": "Decisão ...",
     "rawKeywords": "NECESSIDADE, EXTINÇÃO, TRIBUNAL DO JÚRI, ...",
     "rawLegislation": "LEI-008112/1990 (RJU) ...",
     "rawNotes": "Observação ...",
     "rawDoctrine": "BARROSO, Luís Roberto..."
  },
  "caseData": {
     "caseParties": [
        { "partieType": "REQTE.(S)", "partieName": "PROCURADORA-GERAL DA REPÚBLICA" },
        { "partieType": "INTDO.(A/S)", "partieName": "GOVERNADOR DO ESTADO DO ESPÍRITO SANTO" }
     ],
     "caseKeywords": [
        "licença parental",
        "servidor público",
        "constitucionalidade"
     ],
     "caseDoctrineReferences": [
        {
          "author": "BARROSO, Luís Roberto",
          "publicationTitle": "O controle de constitucionalidade no direito brasileiro: exposição sistemática da doutrina e análise crítica da jurisprudência",
          "edition": "4 ed",
          "publicationPlace": "São Paulo",
          "publisher": "Saraiva",
          "year": 2009,
          "page": "181",
          "rawCitation": "BARROSO, Luís Roberto. O controle de constitucionalidade... p. 181."
        }
     ],
     "caseLegislationReferences": [
        {
          "jurisdictionLevel": "federal",
          "normType": "CF",
          "normIdentifier": "CF-1988",
          "normYear": 1988,
          "normDescription": "Constituição Federal",
          "normReferences": [
             {
                "articleNumber": 5,
                "isCaput": true,
                "incisoNumber": 3,
                "paragraphNumber": null,
                "isParagraphSingle": false,
                "letterCode": null
             }
          ]
        }
     ]
  },
  "processing": {
     "pipelineStatus": "enriched",
     "caseHtmlScrapedAt": "2026-01-26T22:10:00Z",
     "caseContentMinedAt": "2026-01-26T22:35:00Z",
     "caseDoctrineRefsAt": "2026-01-26T22:40:00Z",
     "caseLegislationRefsAt": "2026-01-26T22:41:00Z",
     "lastUpdatedAt": "2026-01-26T22:41:00Z",
     "errors": []
  },
  "status": {
     "pipelineStatus": "caseScraped"
  },
  "sourceIds": {
     "rawHtmlId": "65f0c9f0e1b2c3d4e5f11111"
  }
}


