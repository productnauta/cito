{% extends "base.html" %}
{% block content %}
  <section class="panel">
    <div class="panel-header">
      <h1>Análise de Ministros</h1>
    </div>
    <form class="filters" method="get">
      <label class="field">
        <span>Ministro</span>
        <select name="minister">
          <option value="">Todos</option>
          {% for name in minister_options %}
            <option value="{{ name }}" {% if filters.minister == name %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field">
        <span>Classe processual</span>
        <select name="case_class">
          <option value="">Todas</option>
          {% for value in class_options %}
            <option value="{{ value }}" {% if filters.case_class == value %}selected{% endif %}>{{ value }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field">
        <span>Ano de julgamento</span>
        <input type="text" name="judgment_year" value="{{ filters.judgment_year }}" placeholder="Ex: 2021" />
      </label>
      <label class="field">
        <span>Relator</span>
        <select name="rapporteur">
          <option value="">Todos</option>
          {% for name in rapporteur_options %}
            <option value="{{ name }}" {% if filters.rapporteur == name %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field">
        <span>Data inicial</span>
        <input type="date" name="date_start" value="{{ filters.date_start }}" />
      </label>
      <label class="field">
        <span>Data final</span>
        <input type="date" name="date_end" value="{{ filters.date_end }}" />
      </label>
      <div class="actions">
        <button type="submit">Aplicar filtros</button>
        <a class="secondary" href="{{ url_for('ministros') }}">Limpar</a>
      </div>
    </form>
  </section>

  <section class="kpi-row kpi-row--line5">
    <article class="card">
      <h3>Total de Ministros</h3>
      <p class="card-value">{{ total_ministers }}</p>
    </article>
    <article class="card">
      <h3>Média de casos por Ministro</h3>
      <p class="card-value">
        {% if avg_cases_per_minister is not none %}
          {{ avg_cases_per_minister|round(2) }}
        {% else %}
          —
        {% endif %}
      </p>
    </article>
    <article class="card">
      <h3>Doutrinas por Ministro</h3>
      <p class="card-value">
        {% if doutrinas_per_minister_case is not none %}
          {{ doutrinas_per_minister_case|round(2) }}
        {% else %}
          —
        {% endif %}
      </p>
    </article>
    <article class="card">
      <h3>Legislações por Ministro</h3>
      <p class="card-value">
        {% if legislacoes_per_minister_case is not none %}
          {{ legislacoes_per_minister_case|round(2) }}
        {% else %}
          —
        {% endif %}
      </p>
    </article>
    <article class="card">
      <h3>Acórdãos por Ministro</h3>
      <p class="card-value">
        {% if acordaos_per_minister_case is not none %}
          {{ acordaos_per_minister_case|round(2) }}
        {% else %}
          —
        {% endif %}
      </p>
    </article>
  </section>

  <section class="split-grid">
    <article class="chart-card">
      <div class="panel-header">
        <h2>Ministros mais Ativos</h2>
      </div>
      {% if chart_relatoria_labels %}
        <canvas id="mostActiveChart"></canvas>
      {% else %}
        <p class="empty">Sem dados para o recorte atual.</p>
      {% endif %}
    </article>
    <article class="chart-card">
      <div class="panel-header">
        <h2>Relatorias por Ministro</h2>
      </div>
      {% if chart_relatoria_pct_labels %}
        <canvas id="relatoriaShareChart"></canvas>
      {% else %}
        <p class="empty">Sem dados para o recorte atual.</p>
      {% endif %}
    </article>
  </section>

  <section class="panel">
    {% if ministers %}
      <table>
        <thead>
          <tr>
            <th>Nome do Ministro</th>
            <th>Casos</th>
            <th>Relatorias</th>
            <th>Casos/Ano</th>
            <th>Citado</th>
            <th>Autores</th>
          </tr>
        </thead>
        <tbody>
          {% for row in ministers %}
            <tr>
              <td>
                <a href="{{ url_for('ministro_detail', minister=row.minister, **filter_params_no_minister) }}">
                  {{ row.minister_label }}
                </a>
              </td>
              <td>{{ row.total_processes }}</td>
              <td>{{ row.total_relatorias }}</td>
              <td>
                {% if row.cases_per_year is not none %}
                  {{ row.cases_per_year|round(2) }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td>
                <span title="{{ row.citations_tooltip }}">
                  {{ row.citations_total }}
                </span>
              </td>
              <td>
                <span title="Número total de autores diferentes citados por ele">
                  {{ row.authors_total }}
                </span>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% if show_more %}
        <div class="actions">
          <a class="secondary" href="{{ url_for('ministros', limit=next_limit, **filter_params) }}">Ver mais</a>
        </div>
      {% endif %}
    {% else %}
      <p class="empty">Nenhum ministro encontrado para os filtros atuais.</p>
    {% endif %}
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const relatoriaLabels = {{ chart_relatoria_labels|tojson }};
    const relatoriaValues = {{ chart_relatoria_values|tojson }};
    const relatoriaShareLabels = {{ chart_relatoria_pct_labels|tojson }};
    const relatoriaShareValues = {{ chart_relatoria_pct_values|tojson }};

    if (typeof Chart !== "undefined") {
      Chart.defaults.font.family = getComputedStyle(document.body).fontFamily;
      Chart.defaults.color = "#1a1b1f";

      const activeCanvas = document.getElementById("mostActiveChart");
      if (activeCanvas && relatoriaLabels.length) {
        new Chart(activeCanvas, {
          type: "bar",
          data: {
            labels: relatoriaLabels,
            datasets: [
              {
                label: "Total de relatorias",
                data: relatoriaValues,
                backgroundColor: "rgba(15, 107, 106, 0.4)",
                borderColor: "rgba(15, 107, 106, 1)",
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }

      const shareCanvas = document.getElementById("relatoriaShareChart");
      if (shareCanvas && relatoriaShareLabels.length) {
        const palette = [
          "rgba(15, 107, 106, 0.7)",
          "rgba(31, 140, 127, 0.7)",
          "rgba(118, 179, 157, 0.7)",
          "rgba(239, 203, 155, 0.7)",
          "rgba(224, 112, 97, 0.7)",
          "rgba(128, 93, 160, 0.7)",
          "rgba(94, 117, 128, 0.7)"
        ];
        new Chart(shareCanvas, {
          type: "doughnut",
          data: {
            labels: relatoriaShareLabels,
            datasets: [
              {
                data: relatoriaShareValues,
                backgroundColor: palette
              }
            ]
          },
          options: {
            responsive: true,
            cutout: "62%"
          }
        });
      }
    }
  </script>
{% endblock %}
