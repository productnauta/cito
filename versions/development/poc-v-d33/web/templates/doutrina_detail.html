{% extends "base.html" %}
{% block content %}
  <section class="panel">
    <div class="panel-header">
      <h1>{{ detail_kind }}: {{ detail_value }}</h1>
      <span class="chip">Total de processos: {{ total }}</span>
    </div>
    <p class="panel-copy">
      Lista de processos que referenciam a citacao selecionada.
    </p>
    <div class="actions">
      <a class="secondary" href="{{ url_for('doutrina', **filter_params) }}">Voltar ao painel</a>
    </div>
  </section>

  {% if author_insights %}
    <section class="panel">
      <div class="panel-header">
        <h2>Insights do Autor</h2>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-label">Total de citacoes</span>
          <span class="stat-value">{{ author_insights.total_citations }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Total de citacoes unicas</span>
          <span class="stat-value">{{ author_insights.unique_citations }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Obra mais citada</span>
          <span class="stat-value">{{ author_insights.top_work }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Relator que mais citou</span>
          <span class="stat-value">{{ author_insights.top_rapporteur }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Indice de influencia</span>
          <span class="stat-value" title="{{ author_insights.influence_tooltip }}">
            {{ author_insights.influence_index }}
          </span>
          <span class="helper">Passe o mouse para ver o calculo</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Taxa de recorrencia</span>
          <span class="stat-value">
            {% if author_insights.recurrence_rate is not none %}
              {{ author_insights.recurrence_rate|round(1) }}%
            {% else %}
              â€”
            {% endif %}
          </span>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>Detalhes das citacoes</h2>
      </div>
      <form class="filters" method="get">
        <input type="hidden" name="kind" value="{{ detail_key }}" />
        <input type="hidden" name="value" value="{{ detail_value }}" />
        {% for key, value in filter_params.items() %}
          {% if key not in ['rapporteur', 'judging_body', 'decision'] %}
            <input type="hidden" name="{{ key }}" value="{{ value }}" />
          {% endif %}
        {% endfor %}
        <label class="field">
          <span>Relator</span>
          <input type="text" name="rapporteur" value="{{ filters.rapporteur }}" placeholder="Ex: Gilmar Mendes" />
        </label>
        <label class="field">
          <span>Orgao julgador</span>
          <input type="text" name="judging_body" value="{{ filters.judging_body }}" placeholder="Ex: Plenario" />
        </label>
        <label class="field">
          <span>Decisao final</span>
          <input type="text" name="decision" value="{{ filters.decision }}" placeholder="Ex: Procedente" />
        </label>
        <div class="actions">
          <button type="submit">Aplicar filtros</button>
          <a
            class="secondary"
            href="{{ url_for('doutrina_detail', kind=detail_key, value=detail_value, **filter_params) }}"
          >
            Limpar
          </a>
        </div>
      </form>
      {% if citations %}
        <table class="data-table">
          <thead>
            <tr>
              <th>Titulo do processo</th>
              <th>Relator</th>
              <th>Nome da obra citada</th>
              <th>Classe</th>
              <th>Orgao julgador</th>
              <th>Data do Julgamento</th>
              <th>Decisao final</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody>
            {% for item in citations %}
              <tr>
                <td>
                  {% if item.stf_id %}
                    <a href="{{ url_for('processos_detail', process_id=item.stf_id) }}">{{ item.case_title }}</a>
                  {% else %}
                    {{ item.case_title }}
                  {% endif %}
                </td>
                <td>
                  {% if item.rapporteur %}
                    <a href="{{ url_for('ministro_detail', minister=item.rapporteur) }}">{{ item.rapporteur }}</a>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if item.work %}
                    <a href="{{ url_for('doutrina_detail', kind='title', value=item.work) }}">{{ item.work }}</a>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>{{ item.case_class or '-' }}</td>
                <td>{{ item.judging_body or '-' }}</td>
                <td>{{ item.judgment_date }}</td>
                <td>{{ item.decision_final or '-' }}</td>
                <td>
                  {% if item.case_url %}
                    <a href="{{ item.case_url }}" target="_blank" rel="noopener">Abrir</a>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if author_show_more %}
          <div class="actions">
            <a
              class="secondary"
              href="{{ url_for('doutrina_detail', kind=detail_key, value=detail_value, limit=next_limit, **filter_params) }}"
            >
              Ver mais
            </a>
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Nenhuma citacao encontrada para este autor.</p>
      {% endif %}
    </section>
  {% else %}
    <section class="panel">
      {% if cases %}
        <table class="data-table">
          <thead>
            <tr>
              <th>Titulo do processo</th>
              <th>Data julgamento</th>
              <th>Orgao julgador</th>
              <th>Decisao final</th>
              <th>Voto</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody>
            {% for item in cases %}
              <tr>
                <td>
                  {% if item.stf_id %}
                    <a href="{{ url_for('processos_detail', process_id=item.stf_id) }}">{{ item.case_title }}</a>
                  {% else %}
                    {{ item.case_title }}
                  {% endif %}
                </td>
                <td>{{ item.judgment_date }}</td>
                <td>{{ item.judging_body }}</td>
                <td>{{ item.decision_final }}</td>
                <td>{{ item.vote_type }}</td>
                <td>
                  {% if item.case_url %}
                    <a href="{{ item.case_url }}" target="_blank" rel="noopener">Abrir</a>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if show_more %}
          <div class="actions">
            <a
              class="secondary"
              href="{{ url_for('doutrina_detail', kind=detail_key, value=detail_value, limit=next_limit, **filter_params) }}"
            >
              Ver mais
            </a>
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Nenhum processo encontrado para este filtro.</p>
      {% endif %}
    </section>
  {% endif %}
{% endblock %}
