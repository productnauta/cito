{% extends "base.html" %}
{% block content %}
  <section class="panel filter-panel is-collapsed" data-filter-card>
    <div class="panel-header">
      <h1>Análise de Citações</h1>
      <button type="button" class="secondary filter-toggle" data-filter-toggle aria-expanded="false">
        Mostrar filtros
      </button>
    </div>
    <div class="filter-panel__body">
      <form class="filters" method="get">
      <label class="field">
        <span>Autor</span>
        <input type="text" name="author" value="{{ filters.author }}" placeholder="Ex: HORTA" />
      </label>
      <label class="field">
        <span>Título da publicação</span>
        <input type="text" name="title" value="{{ filters.title }}" placeholder="Ex: Direito Constitucional" />
      </label>
      <label class="field">
        <span>Classe processual</span>
        <input type="text" name="case_class" value="{{ filters.case_class }}" placeholder="Ex: ADI" />
      </label>
      <label class="field">
        <span>Ano de julgamento</span>
        <input type="text" name="judgment_year" value="{{ filters.judgment_year }}" placeholder="Ex: 2021" />
      </label>
      <label class="field">
        <span>Relator</span>
        <input type="text" name="rapporteur" value="{{ filters.rapporteur }}" placeholder="Ex: Gilmar Mendes" />
      </label>
        <div class="actions">
          <button type="submit">Aplicar filtros</button>
          <a class="secondary" href="{{ url_for('analise_citacoes') }}">Limpar</a>
        </div>
      </form>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <h2>Indicadores Médios</h2>
    </div>
    <div class="indicator-bar">
      <div class="indicator-card">
        <span class="indicator-label">Total de Autores</span>
        <span class="indicator-value">{{ authors_total }}</span>
      </div>
      <div class="indicator-card">
        <span class="indicator-label">Total de Obras</span>
        <span class="indicator-value">{{ titles_total }}</span>
      </div>
      <div class="indicator-card">
        <span class="indicator-label">Total de Legislações</span>
        <span class="indicator-value">{{ legislations_total }}</span>
      </div>
      <div class="indicator-card">
        <span class="indicator-label">Total de Acórdãos</span>
        <span class="indicator-value">{{ acordaos_total }}</span>
      </div>
      <div class="indicator-card">
        <span class="indicator-label">Doutrinas por Caso</span>
        <span class="indicator-value">
          {% if doctrines_per_case is not none %}
            {{ doctrines_per_case|round(2) }}
          {% else %}
            —
          {% endif %}
        </span>
      </div>
      <div class="indicator-card">
        <span class="indicator-label">Legislações por Caso</span>
        <span class="indicator-value">
          {% if legislations_per_case is not none %}
            {{ legislations_per_case|round(2) }}
          {% else %}
            —
          {% endif %}
        </span>
      </div>
      <div class="indicator-card">
        <span class="indicator-label">Acórdãos por Caso</span>
        <span class="indicator-value">
          {% if acordaos_per_case is not none %}
            {{ acordaos_per_case|round(2) }}
          {% else %}
            —
          {% endif %}
        </span>
      </div>
    </div>
  </section>

  <section class="kpi-row kpi-row--charts">
    <article class="card">
      <h3>Autores mais citados</h3>
      {% if top_author_labels %}
        <canvas id="topAuthorsChart" class="kpi-chart"></canvas>
      {% else %}
        <p class="empty">Sem dados de autores para o recorte atual.</p>
      {% endif %}
    </article>
    <article class="card">
      <h3>Acórdãos mais citados</h3>
      {% if top_acordao_labels %}
        <canvas id="topAcordaosChart" class="kpi-chart"></canvas>
      {% else %}
        <p class="empty">Sem dados de acórdãos para o recorte atual.</p>
      {% endif %}
    </article>
  </section>

  <section class="panel">
    <div class="panel-header">
      <h2>Autores x Ministro</h2>
    </div>
    {% if heatmap.rows %}
      <div class="heatmap-wrapper">
        <table class="heatmap">
          <thead>
            <tr>
              <th>Autor</th>
              {% for minister in heatmap.ministers %}
                <th class="heatmap-rotated">
                  <a
                    href="{{ url_for('ministro_detail', minister=minister.full) }}"
                    title="{{ minister.full }}"
                  >
                    {{ minister.label }}
                  </a>
                </th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in heatmap.rows %}
              <tr>
                <td class="heatmap-label">
                  <a
                    href="{{ url_for('analise_citacoes_detail', kind='author', value=row.author_full, **filter_params) }}"
                    title="{{ row.author_full }}"
                  >
                    {{ row.author_label }}
                  </a>
                </td>
                {% for cell in row.cells %}
                  {% set minister = heatmap.ministers[loop.index0] %}
                  <td
                    class="heat-cell heat-{{ cell.level }}{% if cell.count == 0 %} is-zero{% endif %}"
                    title="{{ row.author_full }} / {{ minister.full }}: {{ cell.count }} citações"
                  >
                    {% if cell.count %}{{ cell.count }}{% else %}&nbsp;{% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="empty">Sem dados suficientes para compor o heatmap.</p>
    {% endif %}
  </section>

  <section class="split-grid">
    <article class="panel">
      <div class="panel-header">
        <h2>Autores</h2>
      </div>
      {% if authors_rows %}
        <table>
          <thead>
            <tr>
              <th>Autor</th>
              <th>Número de citações</th>
              <th>Percentual</th>
            </tr>
          </thead>
          <tbody>
            {% for row in authors_rows %}
              <tr>
                <td>
                  <a href="{{ url_for('analise_citacoes_detail', kind='author', value=row.label, **filter_params) }}">
                    {{ row.label }}
                  </a>
                </td>
                <td>{{ row.total }}</td>
                <td>
                  {% if row.percent is not none %}
                    {{ row.percent|round(1) }}%
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if authors_total > author_limit %}
          <div class="actions">
            <a
              class="secondary"
              href="{{ url_for('analise_citacoes', author_limit=next_author_limit, title_limit=title_limit, legislation_limit=legislation_limit, acordao_limit=acordao_limit, **filter_params) }}"
            >
              Ver mais
            </a>
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Sem resultados para os filtros atuais.</p>
      {% endif %}
    </article>

    <article class="panel">
      <div class="panel-header">
        <h2>Obras</h2>
      </div>
      {% if titles_rows %}
        <table>
          <thead>
            <tr>
              <th>Título da obra</th>
              <th>Autor</th>
              <th>Número de citações</th>
            </tr>
          </thead>
          <tbody>
            {% for row in titles_rows %}
              <tr>
                <td>
                  <a
                    class="truncate"
                    title="{{ row.title_full }}"
                    href="{{ url_for('analise_citacoes_detail', kind='title', value=row.title_full, **filter_params) }}"
                  >
                    {{ row.title_full }}
                  </a>
                </td>
                <td>
                  {% if row.author_full %}
                    <a href="{{ url_for('analise_citacoes_detail', kind='author', value=row.author_full, **filter_params) }}">
                      {{ row.author_display }}
                    </a>
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>{{ row.total }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if titles_total > title_limit %}
          <div class="actions">
            <a
              class="secondary"
              href="{{ url_for('analise_citacoes', title_limit=next_title_limit, author_limit=author_limit, legislation_limit=legislation_limit, acordao_limit=acordao_limit, **filter_params) }}"
            >
              Ver mais
            </a>
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Sem resultados para os filtros atuais.</p>
      {% endif %}
    </article>
  </section>

  <section class="split-grid">
    <article class="panel">
      <div class="panel-header">
        <h2>Legislações</h2>
      </div>
      {% if legislations_rows %}
        <table>
          <thead>
            <tr>
              <th>Legislação</th>
              <th>Número de citações</th>
              <th>Tipo</th>
            </tr>
          </thead>
          <tbody>
            {% for row in legislations_rows %}
              <tr>
                <td>
                  <a
                    class="truncate"
                    title="{{ row.label }}"
                    href="{{ url_for('processos', legislation_norm=row.label) }}"
                  >
                    {{ row.label }}
                  </a>
                </td>
                <td>{{ row.total }}</td>
                <td>{{ row.norm_type }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if legislations_total > legislation_limit %}
          <div class="actions">
            <a
              class="secondary"
              href="{{ url_for('analise_citacoes', legislation_limit=next_legislation_limit, author_limit=author_limit, title_limit=title_limit, acordao_limit=acordao_limit, **filter_params) }}"
            >
              Ver mais
            </a>
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Sem resultados para os filtros atuais.</p>
      {% endif %}
    </article>

    <article class="panel">
      <div class="panel-header">
        <h2>Acórdãos</h2>
      </div>
      {% if acordaos_rows %}
        <table>
          <thead>
            <tr>
              <th>Número do acórdão</th>
              <th>Número de citações</th>
              <th>Ano</th>
            </tr>
          </thead>
          <tbody>
            {% for row in acordaos_rows %}
              <tr>
                <td>
                  <a
                    class="truncate"
                    title="{{ row.label }}"
                    href="{{ url_for('processos', acordao_ref=row.label) }}"
                  >
                    {{ row.label }}
                  </a>
                </td>
                <td>{{ row.total }}</td>
                <td>{{ row.year or '—' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if acordaos_total > acordao_limit %}
          <div class="actions">
            <a
              class="secondary"
              href="{{ url_for('analise_citacoes', acordao_limit=next_acordao_limit, author_limit=author_limit, title_limit=title_limit, legislation_limit=legislation_limit, **filter_params) }}"
            >
              Ver mais
            </a>
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Sem resultados para os filtros atuais.</p>
      {% endif %}
    </article>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const topAuthorLabels = {{ top_author_labels|tojson }};
    const topAuthorValues = {{ top_author_values|tojson }};
    const topAcordaoLabels = {{ top_acordao_labels|tojson }};
    const topAcordaoValues = {{ top_acordao_values|tojson }};

    if (typeof Chart !== "undefined") {
      Chart.defaults.font.family = getComputedStyle(document.body).fontFamily;
      Chart.defaults.color = "#1a1b1f";

      const chartCanvas = document.getElementById("topAuthorsChart");
      if (chartCanvas && topAuthorLabels.length) {
        const palette = [
          "rgba(15, 107, 106, 0.7)",
          "rgba(31, 140, 127, 0.7)",
          "rgba(118, 179, 157, 0.7)",
          "rgba(239, 203, 155, 0.7)",
          "rgba(224, 112, 97, 0.7)",
          "rgba(128, 93, 160, 0.7)"
        ];

        new Chart(chartCanvas, {
          type: "pie",
          data: {
            labels: topAuthorLabels,
            datasets: [
              {
                data: topAuthorValues,
                backgroundColor: palette
              }
            ]
          },
          options: {
            responsive: true
          }
        });
      }

      const acordaoCanvas = document.getElementById("topAcordaosChart");
      if (acordaoCanvas && topAcordaoLabels.length) {
        new Chart(acordaoCanvas, {
          type: "bar",
          data: {
            labels: topAcordaoLabels,
            datasets: [
              {
                label: "Número de citações",
                data: topAcordaoValues,
                backgroundColor: "rgba(31, 140, 127, 0.6)",
                borderColor: "rgba(31, 140, 127, 1)",
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true }
            }
          }
        });
      }
    }
  </script>
{% endblock %}
