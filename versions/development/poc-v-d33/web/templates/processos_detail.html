{% extends "base.html" %}

{% block content %}
  <section class="panel">
    <div class="panel-header">
      <div>
        <h1>
          {% if detail.stf_id %}
            <a href="{{ url_for('processos_detail', process_id=detail.stf_id) }}">{{ detail.title }}</a>
          {% else %}
            {{ detail.title }}
          {% endif %}
        </h1>
        <p class="panel-copy">Detalhes completos do processo e referencias extraidas.</p>
      </div>
      <a class="secondary" href="{{ url_for('processos') }}">Voltar</a>
    </div>
    <div class="summary-cards">
      <article class="card">
        <h3>Classe</h3>
        <p class="card-value">{{ detail.case_class }}</p>
        <span class="card-meta">STF ID: {{ detail.stf_id }}</span>
      </article>
      <article class="card">
        <h3>Relator</h3>
        <p class="card-value">
          {% if detail.rapporteur and detail.rapporteur != '-' %}
            <a href="{{ url_for('ministro_detail', minister=detail.rapporteur) }}">{{ detail.rapporteur }}</a>
          {% else %}
            {{ detail.rapporteur }}
          {% endif %}
        </p>
        <span class="card-meta">Orgao: {{ detail.judging_body }}</span>
      </article>
      <article class="card">
        <h3>Data de julgamento</h3>
        <p class="card-value">{{ detail.judgment_date }}</p>
        <span class="card-meta">Publicacao: {{ detail.publication_date }}</span>
      </article>
      <article class="card">
        <h3>Doutrinas citadas</h3>
        <p class="card-value">{{ detail.doctrine_refs|length }}</p>
        <span class="card-meta">Total de referencias extraidas</span>
      </article>
      <article class="card">
        <h3>Legislacoes citadas</h3>
        <p class="card-value">{{ detail.legislation_refs_total or 0 }}</p>
        <span class="card-meta">Normas distintas: {{ detail.legislation_norms_total or 0 }}</span>
      </article>
      <article class="card">
        <h3>Total de partes</h3>
        <p class="card-value">{{ detail.parties_count or 0 }}</p>
        <span class="card-meta">Partes identificadas</span>
      </article>
      <article class="card">
        <h3>Decisao final</h3>
        <p class="card-value">{{ detail.decision_final or 'NÃ£o identificado' }}</p>
        <span class="card-meta">Resultado do julgamento</span>
      </article>
    </div>
  </section>

  <section class="panel">
    <div class="panel-header">
      <h2>Linha do tempo</h2>
    </div>
    {% if detail.timeline %}
      <ol class="timeline">
        {% for item in detail.timeline %}
          <li>
            <span class="timeline-date">{{ item.date }}</span>
            <span class="timeline-label">{{ item.label }}</span>
          </li>
        {% endfor %}
      </ol>
    {% else %}
      <p class="empty">Sem eventos registrados para este processo.</p>
    {% endif %}
  </section>

  <section class="panel">
    <div class="panel-header">
      <h2>Votos dos ministros</h2>
    </div>
    {% if detail.minister_votes %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Ministro</th>
            <th>Voto</th>
          </tr>
        </thead>
        <tbody>
          {% for vote in detail.minister_votes %}
            <tr>
              <td>{{ vote.minister }}</td>
              <td>
                <span
                  class="vote-badge {{ vote.vote_class }}"
                  {% if vote.vote == 'Outros' %}title="Voto nao classificado."{% endif %}
                >
                  {{ vote.vote }}
                </span>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="empty">Sem dados de votos.</p>
    {% endif %}
  </section>

  <section class="panel">
    <div class="panel-header">
      <h2>Mapa de argumentos do processo</h2>
    </div>
    <div class="argument-map">
      <div class="argument-node argument-node--center">
        <span>Decisao final</span>
        <strong>{{ detail.argument_map.decision_final }}</strong>
      </div>
      <div class="argument-node">
        <span>Doutrinas</span>
        <strong>{{ detail.argument_map.doctrines }}</strong>
      </div>
      <div class="argument-node">
        <span>Legislacao</span>
        <strong>{{ detail.argument_map.legislation }}</strong>
      </div>
      <div class="argument-node">
        <span>Precedentes</span>
        <strong>{{ detail.argument_map.acordaos }}</strong>
      </div>
    </div>
    <p class="helper">Relacao simplificada entre a decisao final e as fontes citadas.</p>
  </section>

  <section class="panel">
    <div class="panel-header">
      <h2>Doutrinas Citadas</h2>
      <span class="chip">{{ detail.doctrine_refs|length }} citacao(oes)</span>
    </div>
    {% if detail.doctrine_refs %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Autor</th>
            <th>Obra</th>
            <th>Edicao</th>
            <th>Ano</th>
            <th>Pagina</th>
          </tr>
        </thead>
        <tbody>
          {% for ref in detail.doctrine_refs %}
            <tr>
              <td>
                {% if ref.author %}
                  <a href="{{ url_for('analise_citacoes_detail', kind='author', value=ref.author) }}">{{ ref.author }}</a>
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if ref.publicationTitleDisplay or ref.publicationTitle %}
                  <a href="{{ url_for('analise_citacoes_detail', kind='title', value=ref.publicationTitleDisplay or ref.publicationTitle) }}">
                    {{ ref.publicationTitleDisplay or ref.publicationTitle }}
                  </a>
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ ref.edition or '-' }}</td>
              <td>{{ ref.year or '-' }}</td>
              <td>{{ ref.page or '-' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="empty">Nenhuma doutrina encontrada.</p>
    {% endif %}
  </section>
  <section class="grid">
    <article class="panel">
      <div class="panel-header">
        <h2>Palavras-chave</h2>
        <span class="chip">{{ detail.keywords|length }} itens</span>
      </div>
      {% if detail.keywords %}
        <div class="chip-row">
          {% for kw in detail.keywords[:20] %}
            <span class="chip small">{{ kw }}</span>
          {% endfor %}
        </div>
        {% if detail.keywords|length > 20 %}
          <div class="actions">
            <button class="secondary toggle-chips" data-target="keywords">Ver mais</button>
          </div>
          <div class="chip-row chip-row--hidden" data-chip-group="keywords">
            {% for kw in detail.keywords[20:] %}
              <span class="chip small">{{ kw }}</span>
            {% endfor %}
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Sem palavras-chave cadastradas.</p>
      {% endif %}
    </article>

    <article class="panel">
      <div class="panel-header">
        <h2>Legislacao Citada</h2>
        <span class="chip">{{ detail.legislation_refs|length }} normas</span>
      </div>
      {% if detail.legislation_ids %}
        <div class="chip-row">
          {% for norm in detail.legislation_ids[:20] %}
            <a class="chip small chip-link" href="{{ url_for('processos', legislation_norm=norm) }}">
              {{ norm }}
            </a>
          {% endfor %}
        </div>
        {% if detail.legislation_ids|length > 20 %}
          <div class="actions">
            <button class="secondary toggle-chips" data-target="legislation">Ver mais</button>
          </div>
          <div class="chip-row chip-row--hidden" data-chip-group="legislation">
            {% for norm in detail.legislation_ids[20:] %}
              <a class="chip small chip-link" href="{{ url_for('processos', legislation_norm=norm) }}">
                {{ norm }}
              </a>
            {% endfor %}
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Sem referencias legislativas.</p>
      {% endif %}
    </article>
  </section>

  <section class="panel">
    <div class="panel-header">
      <h2>Partes do Processo</h2>
      <span class="chip">{{ detail.parties|length }} partes</span>
    </div>
    {% if detail.parties %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Tipo da Parte</th>
            <th>Nome da Parte</th>
          </tr>
        </thead>
        <tbody>
          {% for party in detail.parties[:10] %}
            <tr>
              <td>{{ party.type or '-' }}</td>
              <td>{{ party.name or '-' }}</td>
            </tr>
          {% endfor %}
          {% if detail.parties|length > 10 %}
            {% for party in detail.parties[10:] %}
              <tr class="table-row--hidden" data-row-group="parties">
                <td>{{ party.type or '-' }}</td>
                <td>{{ party.name or '-' }}</td>
              </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
      {% if detail.parties|length > 10 %}
        <div class="actions">
          <button class="secondary toggle-rows" data-target="parties">Exibir mais</button>
        </div>
      {% endif %}
    {% else %}
      <p class="empty">Nenhuma parte cadastrada.</p>
    {% endif %}
  </section>

  <section class="panel">
    <div class="panel-header">
      <h2>Links para documentos originais</h2>
    </div>
    {% if detail.links %}
      <ul class="link-list">
        {% for link in detail.links %}
          <li><a href="{{ link.url }}" target="_blank" rel="noopener">{{ link.label }}</a></li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="empty">Nenhum link disponivel.</p>
    {% endif %}
  </section>

  <script>
    document.querySelectorAll('.toggle-chips').forEach((btn) => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-target');
        const group = document.querySelector(`[data-chip-group=\"${target}\"]`);
        if (!group) return;
        const hidden = group.classList.toggle('chip-row--hidden');
        btn.textContent = hidden ? 'Ver mais' : 'Ver menos';
      });
    });

    document.querySelectorAll('.toggle-rows').forEach((btn) => {
      btn.addEventListener('click', () => {
        const target = btn.getAttribute('data-target');
        const rows = document.querySelectorAll(`[data-row-group=\"${target}\"]`);
        if (!rows.length) return;
        const anyHidden = Array.from(rows).some((row) => row.classList.contains('table-row--hidden'));
        rows.forEach((row) => row.classList.toggle('table-row--hidden', !anyHidden));
        btn.textContent = anyHidden ? 'Ver menos' : 'Exibir mais';
      });
    });
  </script>
{% endblock %}
