{% extends "base.html" %}

{% block content %}
  <section class="panel filter-panel is-collapsed" data-filter-card>
    <div class="panel-header">
      <div>
        <h1>Processos</h1>
        <p class="panel-copy">Visualize os processos extraidos e filtre por criterios juridicos.</p>
      </div>
      <span class="chip">{{ total }} processos</span>
      <button type="button" class="secondary filter-toggle" data-filter-toggle aria-expanded="false">
        Mostrar filtros
      </button>
    </div>
    <div class="filter-panel__body">
      <form class="filters" method="get">
      <label class="field">
        <span>Titulo do processo</span>
        <input type="text" name="title" value="{{ filters.title }}" placeholder="Ex: ADI 1234" />
      </label>
      <label class="field">
        <span>Classe do processo</span>
        <select name="case_class">
          <option value="">Todas</option>
          {% for cls in class_options %}
            <option value="{{ cls }}" {% if filters.case_class == cls %}selected{% endif %}>{{ cls }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field">
        <span>Relator</span>
        <select name="rapporteur">
          <option value="">Todos</option>
          {% for r in rapporteur_options %}
            <option value="{{ r }}" {% if filters.rapporteur == r %}selected{% endif %}>{{ r }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="field">
        <span>Data inicial</span>
        <input type="date" name="date_start" value="{{ filters.date_start }}" />
      </label>
      <label class="field">
        <span>Data final</span>
        <input type="date" name="date_end" value="{{ filters.date_end }}" />
      </label>
      <label class="field">
        <span>Autor citado</span>
        <input list="author-suggestions" name="author" value="{{ filters.author }}" placeholder="Ex: CANOTILHO" />
        <datalist id="author-suggestions">
          {% for a in author_suggestions %}
            <option value="{{ a }}"></option>
          {% endfor %}
        </datalist>
      </label>
      <label class="field">
        <span>Legislacao</span>
        <input type="text" name="legislation_norm" value="{{ filters.legislation_norm }}" placeholder="Ex: CF-1988" />
      </label>
      <label class="field">
        <span>Acordao</span>
        <input type="text" name="acordao_ref" value="{{ filters.acordao_ref }}" placeholder="Ex: ADI 1234" />
      </label>
        <div class="actions">
          <button type="submit">Aplicar filtros</button>
          <a class="secondary" href="{{ url_for('processos') }}">Limpar</a>
        </div>
      </form>
    </div>
  </section>

  <section class="summary-cards" id="process-kpis">
    <article class="card">
      <h3>Total de Processos</h3>
      <p class="card-value" data-kpi="total">
        {{ kpis.total_processes }}
      </p>
    </article>
    <article class="card">
      <h3>Processos/Relator</h3>
      <p class="card-value" data-kpi="per-rapporteur">
        {% if kpis.processes_per_rapporteur is not none %}
          {{ '%.2f'|format(kpis.processes_per_rapporteur) }}
        {% else %}
          —
        {% endif %}
      </p>
      <span class="card-meta">processos por relator</span>
    </article>
    <article class="card">
      <h3>Doutrinas por Caso</h3>
      <p class="card-value" data-kpi="doctrines">
        {% if kpis.doctrines_per_case is not none %}
          {{ kpis.doctrines_per_case }}
        {% else %}
          —
        {% endif %}
      </p>
      <span class="card-meta">citacoes doutrinarias/caso</span>
    </article>
    <article class="card">
      <h3>Citacoes de Legislacao</h3>
      <p class="card-value" data-kpi="legislation">
        {% if kpis.legislation_per_case is not none %}
          {{ kpis.legislation_per_case }}
        {% else %}
          —
        {% endif %}
      </p>
      <span class="card-meta">citacoes de legislacao/caso</span>
    </article>
  </section>

  <section class="tag-cloud-grid">
    <article class="panel tag-cloud-card">
      <div class="panel-header">
        <h2>Doutrinas</h2>
      </div>
      {% if tag_clouds.doctrine %}
        <div class="tag-cloud">
          {% for tag in tag_clouds.doctrine %}
            <a
              class="tag-pill {{ tag.size_class }}"
              href="{{ url_for('processos', author=tag.label, **filter_params_no_author) }}"
            >
              {{ tag.label }} ({{ tag.count }})
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="empty">Sem dados de doutrinas.</p>
      {% endif %}
    </article>

    <article class="panel tag-cloud-card">
      <div class="panel-header">
        <h2>Legislacao</h2>
      </div>
      {% if tag_clouds.legislation %}
        <div class="tag-cloud">
          {% for tag in tag_clouds.legislation %}
            <a
              class="tag-pill {{ tag.size_class }}"
              href="{{ url_for('processos', legislation_norm=tag.label, **filter_params_no_legislation) }}"
            >
              {{ tag.label }} ({{ tag.count }})
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="empty">Sem dados de legislacao.</p>
      {% endif %}
    </article>

    <article class="panel tag-cloud-card">
      <div class="panel-header">
        <h2>Acordaos</h2>
      </div>
      {% if tag_clouds.acordao %}
        <div class="tag-cloud">
          {% for tag in tag_clouds.acordao %}
            <a
              class="tag-pill {{ tag.size_class }}"
              href="{{ url_for('processos', acordao_ref=tag.label, **filter_params_no_acordao) }}"
            >
              {{ tag.label }} ({{ tag.count }})
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="empty">Sem dados de acordaos.</p>
      {% endif %}
    </article>
  </section>

  <section class="panel">
    {% if processes %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Titulo do processo</th>
            <th>Classe</th>
            <th>Relator</th>
            <th>Data de julgamento</th>
            <th>Doutrinas</th>
            <th>Palavras-chave</th>
            <th>Legislacao</th>
            <th>Partes</th>
          </tr>
        </thead>
        <tbody>
          {% for row in processes %}
            <tr>
              <td>
                <a href="{{ url_for('processos_detail', process_id=row.stf_id) }}">{{ row.case_title }}</a>
              </td>
              <td>{{ row.case_class }}</td>
              <td>
                {% if row.rapporteur and row.rapporteur != '-' %}
                  <a href="{{ url_for('ministro_detail', minister=row.rapporteur) }}">{{ row.rapporteur }}</a>
                {% else %}
                  {{ row.rapporteur }}
                {% endif %}
              </td>
              <td>{{ row.judgment_date }}</td>
              <td>{{ row.doctrine_count }}</td>
              <td>{{ row.keywords_count }}</td>
              <td>{{ row.legislation_count }}</td>
              <td>{{ row.parties_count }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% if show_more %}
        <div class="actions">
          <a class="secondary" href="{{ url_for('processos', limit=next_limit, **filter_params) }}">Ver mais</a>
        </div>
      {% endif %}
    {% else %}
      <p class="empty">Nenhum processo encontrado para os filtros atuais.</p>
    {% endif %}
  </section>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      fetch(`/processos/kpis?${params.toString()}`)
        .then((resp) => resp.json())
        .then((data) => {
          const elTotal = document.querySelector('[data-kpi="total"]');
          const elPerRap = document.querySelector('[data-kpi="per-rapporteur"]');
          const elDoc = document.querySelector('[data-kpi="doctrines"]');
          const elLeg = document.querySelector('[data-kpi="legislation"]');

          if (elTotal) elTotal.textContent = data.totalProcesses ?? "—";
          if (elPerRap) {
            elPerRap.textContent = data.processesPerRapporteur != null
              ? data.processesPerRapporteur.toFixed(2)
              : "—";
          }
          if (elDoc) elDoc.textContent = data.doctrinesPerCase != null ? data.doctrinesPerCase : "—";
          if (elLeg) elLeg.textContent = data.legislationCitationsPerCase != null ? data.legislationCitationsPerCase : "—";
        })
        .catch(() => {
          // mantém valores do render server-side
        });
    })();
  </script>
{% endblock %}
