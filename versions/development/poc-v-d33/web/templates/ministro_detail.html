{% extends "base.html" %}
{% block content %}
  <section class="panel">
    <div class="panel-header">
      <h1>Ministro: {{ minister_name }}</h1>
      <span class="chip">{{ labels.summary_analytics }}</span>
    </div>
    <p class="panel-copy">
      Indicadores consolidados e rankings de referencias vinculadas ao ministro.
    </p>
    <div class="actions">
      <a class="secondary" href="{{ url_for('ministros', **filter_params_no_minister) }}">Voltar aos ministros</a>
    </div>
  </section>

  <section class="stats-grid">
    <article class="panel stat-card">
      <span class="stat-label" title="Total de processos em que o ministro atuou no recorte atual.">
        {{ labels.total_processes }}
      </span>
      <strong class="stat-value">{{ total_processes }}</strong>
    </article>
    <article class="panel stat-card">
      <span class="stat-label" title="Total de processos em que o ministro foi relator no recorte atual.">
        {{ labels.total_relatorias }}
      </span>
      <strong class="stat-value">
        <a href="{{ url_for('processos', rapporteur=minister_name) }}">{{ total_relatorias }}</a>
      </strong>
    </article>
    <a
      class="panel stat-card stat-card-link"
      href="{{ url_for('processos', rapporteur=minister_name, citations_made=1, **process_filter_params) }}"
    >
      <span class="stat-label" title="Total de processos com citações registradas no recorte atual.">
        {{ labels.citations_made }}
      </span>
      <span class="stat-subtitle">{{ labels.citations_subtitle }}</span>
      <strong class="stat-value">{{ total_citations }}</strong>
    </a>
    <article class="panel stat-card">
      <span class="stat-label" title="Percentual de decisões procedentes no recorte atual.">
        {{ labels.procedence_rate }}
      </span>
      <strong class="stat-value">
        {% if procedence_rate is not none %}
          {{ procedence_rate|round(1) }}%
        {% else %}
          —
        {% endif %}
      </strong>
    </article>
    <article class="panel stat-card">
      <span class="stat-label" title="Média de citações por processo no recorte atual.">
        {{ labels.avg_citations }}
      </span>
      <strong class="stat-value">
        {% if avg_citations_per_process is not none %}
          {{ avg_citations_per_process|round(2) }}
        {% else %}
          —
        {% endif %}
      </strong>
    </article>
    <article class="panel stat-card">
      <span class="stat-label" title="Diversidade de fontes citadas (autores e legislações distintas).">
        {{ labels.diversity_sources }}
      </span>
      <div class="stat-stack">
        <span><strong>{{ distinct_authors }}</strong> {{ labels.distinct_authors }}</span>
        <span><strong>{{ distinct_norms }}</strong> {{ labels.distinct_norms }}</span>
      </div>
    </article>
  </section>

  <section class="grid">
    <article class="panel">
      <div class="panel-header">
        <h2 title="Autores doutrinários mais citados pelo ministro.">{{ labels.doutrinas }}</h2>
      </div>
      {% if top_doctrine %}
        <table>
          <thead>
            <tr>
              <th>{{ labels.th_autor }}</th>
              <th>{{ labels.th_total }}</th>
            </tr>
          </thead>
          <tbody>
            {% for row in top_doctrine %}
            <tr>
              <td>
                <a href="{{ url_for('analise_citacoes_detail', kind='author', value=row.label) }}">{{ row.label }}</a>
              </td>
              <td>{{ row.total }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        {% if show_more_doctrine %}
          <div class="actions">
            <a
              class="secondary"
              href="{{ url_for('ministro_detail', minister=minister_name, doctrine_limit=next_doctrine_limit, acordao_limit=acordao_limit, legislation_limit=legislation_limit, decision_limit=decision_limit, relatoria_limit=relatoria_limit, **filter_params_no_minister) }}"
            >
              Ver mais
            </a>
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Sem citacoes doutrinarias para os filtros atuais.</p>
      {% endif %}
    </article>

    <article class="panel">
      <div class="panel-header">
        <h2 title="Acórdãos mais citados pelo ministro.">{{ labels.acordaos }}</h2>
      </div>
      {% if top_norms %}
        <table>
          <thead>
            <tr>
              <th>{{ labels.th_acordao }}</th>
              <th>{{ labels.th_total }}</th>
            </tr>
          </thead>
          <tbody>
            {% for row in top_norms %}
              <tr>
                <td>{{ row.label }}</td>
                <td>{{ row.total }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if show_more_acordao %}
          <div class="actions">
            <a
              class="secondary"
              href="{{ url_for('ministro_detail', minister=minister_name, acordao_limit=next_acordao_limit, doctrine_limit=doctrine_limit, legislation_limit=legislation_limit, decision_limit=decision_limit, relatoria_limit=relatoria_limit, **filter_params_no_minister) }}"
            >
              Ver mais
            </a>
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Sem referencias normativas ou jurisprudenciais para os filtros atuais.</p>
      {% endif %}
    </article>

    <article class="panel">
      <div class="panel-header">
        <h2 title="Legislações mais citadas pelo ministro.">{{ labels.legislacoes }}</h2>
      </div>
      {% if top_legislation %}
        <table>
          <thead>
            <tr>
              <th>{{ labels.th_legislacao }}</th>
              <th>{{ labels.th_total }}</th>
            </tr>
          </thead>
          <tbody>
            {% for row in top_legislation %}
              <tr>
                <td>
                  <a href="{{ url_for('legislacao_detail', norm=row.label) }}">{{ row.label }}</a>
                </td>
                <td>{{ row.total }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if show_more_legislation %}
          <div class="actions">
            <a
              class="secondary"
              href="{{ url_for('ministro_detail', minister=minister_name, legislation_limit=next_legislation_limit, doctrine_limit=doctrine_limit, acordao_limit=acordao_limit, decision_limit=decision_limit, relatoria_limit=relatoria_limit, **filter_params_no_minister) }}"
            >
              Ver mais
            </a>
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Sem referencias legislativas para os filtros atuais.</p>
      {% endif %}
    </article>
  </section>

  <section class="grid">
    <article class="panel">
      <div class="panel-header">
        <h2 title="Distribuição de decisões finais no recorte atual.">{{ labels.decisoes }}</h2>
      </div>
      {% if decision_distribution %}
        <table>
          <thead>
            <tr>
              <th>{{ labels.th_decisao }}</th>
              <th>{{ labels.th_total }}</th>
            </tr>
          </thead>
          <tbody>
            {% for row in decision_distribution %}
              <tr>
                <td>{{ row.label }}</td>
                <td>{{ row.total }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if show_more_decision %}
          <div class="actions">
            <a
              class="secondary"
              href="{{ url_for('ministro_detail', minister=minister_name, decision_limit=next_decision_limit, doctrine_limit=doctrine_limit, acordao_limit=acordao_limit, legislation_limit=legislation_limit, relatoria_limit=relatoria_limit, **filter_params_no_minister) }}"
            >
              Ver mais
            </a>
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Sem dados de decisao para os filtros atuais.</p>
      {% endif %}
    </article>

    <article class="panel">
      <div class="panel-header">
        <h2 title="Processos em que o ministro atuou como relator.">{{ labels.relatoria_processos }}</h2>
        <span class="chip">{{ relatoria_total }} processos</span>
      </div>
      {% if relatoria_cases %}
        <table class="data-table">
          <thead>
            <tr>
              <th>{{ labels.th_titulo_caso }}</th>
              <th>{{ labels.th_processo }}</th>
              <th>{{ labels.th_decisao }}</th>
            </tr>
          </thead>
          <tbody>
            {% for row in relatoria_cases %}
              <tr>
                <td>
                  {% if row.stf_id %}
                    <a href="{{ url_for('processos_detail', process_id=row.stf_id) }}">{{ row.case_title }}</a>
                  {% else %}
                    {{ row.case_title }}
                  {% endif %}
                </td>
                <td>{{ row.process_label }}</td>
                <td>{{ row.decision_final }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if show_more_relatoria %}
          <div class="actions">
            <a
              class="secondary"
              href="{{ url_for('ministro_detail', minister=minister_name, relatoria_limit=next_relatoria_limit, doctrine_limit=doctrine_limit, acordao_limit=acordao_limit, legislation_limit=legislation_limit, decision_limit=decision_limit, **filter_params_no_minister) }}"
            >
              Ver mais
            </a>
          </div>
        {% endif %}
      {% else %}
        <p class="empty">Nenhum processo encontrado para este ministro.</p>
      {% endif %}
    </article>
  </section>

  <section class="chart-grid">
    <article class="chart-card">
      <div class="panel-header">
        <h2 title="Evolução do número de decisões por ano.">{{ labels.chart_decisions_year }}</h2>
      </div>
      <canvas id="decisionsByYearChart"></canvas>
    </article>
    <article class="chart-card">
      <div class="panel-header">
        <h2 title="Perfil de decisões por resultado.">{{ labels.chart_decision_profile }}</h2>
      </div>
      <canvas id="decisionProfileChart"></canvas>
    </article>
    <article class="chart-card">
      <div class="panel-header">
        <h2 title="Citações por tipo de fonte no recorte atual.">{{ labels.chart_citation_sources }}</h2>
      </div>
      <canvas id="citationSourcesChart"></canvas>
    </article>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function () {
      if (typeof Chart === "undefined") {
        return;
      }
      Chart.defaults.font.family = getComputedStyle(document.body).fontFamily;
      Chart.defaults.color = "#1a1b1f";

      const decisionsByYear = {{ decisions_by_year|tojson }};
      const decisionProfile = {{ decision_profile|tojson }};
      const citationSources = {{ citation_sources|tojson }};

      const yearCanvas = document.getElementById("decisionsByYearChart");
      if (yearCanvas) {
        new Chart(yearCanvas, {
          type: "line",
          data: {
            labels: decisionsByYear.map((item) => item.year),
            datasets: [
              {
                label: "Decisões",
                data: decisionsByYear.map((item) => item.total),
                borderColor: "#0f6b6a",
                backgroundColor: "rgba(15, 107, 106, 0.15)",
                fill: true,
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { precision: 0 },
              },
            },
          },
        });
      }

      const profileCanvas = document.getElementById("decisionProfileChart");
      if (profileCanvas) {
        new Chart(profileCanvas, {
          type: "bar",
          data: {
            labels: decisionProfile.map((item) => item.label),
            datasets: [
              {
                label: "Decisões",
                data: decisionProfile.map((item) => item.total),
                backgroundColor: ["#1f8c7f", "#e07061", "#f4b26f", "#9aa3ab"],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: { precision: 0 },
              },
            },
          },
        });
      }

      const sourcesCanvas = document.getElementById("citationSourcesChart");
      if (sourcesCanvas) {
        new Chart(sourcesCanvas, {
          type: "bar",
          data: {
            labels: ["Doutrina", "Legislação", "Acórdãos"],
            datasets: [
              {
                label: "Citações",
                data: [
                  citationSources.doutrina || 0,
                  citationSources.legislacao || 0,
                  citationSources.acordaos || 0,
                ],
                backgroundColor: ["#0f6b6a", "#76b39d", "#1f8c7f"],
              },
            ],
          },
          options: {
            indexAxis: "y",
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                beginAtZero: true,
                ticks: { precision: 0 },
              },
            },
          },
        });
      }
    })();
  </script>
{% endblock %}
